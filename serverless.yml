org: diegoladrondeg
service: api-gestion-usuarios

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 60
  
  #  CORRECCIN 1: La sintaxis de 'role' e 'iam' para Serverless V4
  # Asignamos el ARN del rol acad茅mico existente
  role: arn:aws:iam::049376646199:role/LabRole
  
  # Definimos las declaraciones adicionales que se deben aplicar a ese rol
  iam:
    role:
      statements:
        # 1. Permiso para usar Amazon Rekognition (An谩lisis de im谩genes)
        - Effect: Allow
          Action:
            - rekognition:DetectLabels
            - rekognition:DetectFaces
          Resource: "*"
        # 2. Permiso para leer la clave API de Secrets Manager
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:ExternalApiKeySecret-*"
  
  # Variables de Entorno
  environment:
    DYNAMODB_TABLE_NAME: ${self:custom.usuarioTableName.${self:provider.stage}}
    S3_BUCKET_NAME: ${self:custom.imagesBucketName.${self:provider.stage}}
    STAGE: ${self:provider.stage}


#  CORRECCIN 2: Configuraci贸n del comando Python para el plugin (ENOENT fix)
custom:
  # Opciones para el plugin de requisitos de Python
  pythonRequirements:
    pythonBin: python3 # Usamos 'python3' en lugar de 'python3.11' para evitar el error ENOENT en muchos Linux
  
  usuarioTableName:
    dev: ${self:service}-dev-usuario_bd
    test: ${self:service}-test-usuario_bd
    prod: ${self:service}-prod-usuario_bd

  imagesBucketName:
    dev: ${self:service}-dev-images-bucket
    test: ${self:service}-test-images-bucket
    prod: ${self:service}-prod-images-bucket


# --- Funciones Lambda ---
functions:
  # 1. Funci贸n de Registro
  register:
    handler: src/register.lambda_handler
    events:
      - http:
          path: /auth/register
          method: post
          cors: true

  # 2. Funci贸n de Login
  login:
    handler: src/login.lambda_handler
    events:
      - http:
          path: /auth/login
          method: post
          cors: true

  # 3. Funci贸n para obtener URL de subida
  get_upload_url:
    handler: src/get_upload_url.lambda_handler
    events:
      - http:
          path: /images/upload-url
          method: post
          cors: true

  # 4. Funci贸n de An谩lisis y Generaci贸n de Imagen
  ai_generate:
    handler: src/ai_generate.lambda_handler
    timeout: 60
    memorySize: 1024
    events:
      - http:
          path: /images/generate
          method: post
          cors: true
    environment:
      EXTERNAL_SECRET_NAME: ExternalApiKeySecret-${self:provider.stage}


# --- Recursos Adicionales (DynamoDB, S3 y Secrets Manager) ---
resources:
  Resources:
    # 1. Tabla DynamoDB 'usuario_bd'
    UsuarioDBTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.usuarioTableName.${self:provider.stage}}
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    # 2. Bucket S3 para las im谩genes de los usuarios
    ImagesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.imagesBucketName.${self:provider.stage}}
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - '*'
              AllowedMethods:
                - PUT
              AllowedOrigins:
                - '*'
              MaxAge: 3000
              
    # 3. Secrets Manager para el token de Replicate
    ExternalApiKeySecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: ExternalApiKeySecret-${self:provider.stage}
        Description: Token API para la plataforma Replicate (Generaci贸n de im谩genes Stable Diffusion)
        # 锔 IMPORTANTE: Recuerda que este valor es un placeholder para evitar el error de GitHub.
        # Debes actualizarlo manualmente en Secrets Manager despu茅s de desplegar.
        SecretString: "PLACEHOLDER_TOKEN_DEBE_SER_ACTUALIZADO"

